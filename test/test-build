#!/bin/bash

# check user
if [ `whoami` != 'root' ]; then
    echo "ALMiniumのインストールはルートユーザで行う必要があります。"
    echo "rootユーザもしくはsudoで実行してください。"
    exit 1
fi

# build docker-alminium
git clone https://github.com/ayapapa/docker-alminium.git .test
pushd .test && rm -r .git
BRANCH_NAME="`git branch --contains=HEAD | awk '{print $2}'`"
sed -i.org \
    -e "s/ALM_VER=\"master\"/ALM_VER=\"$BRANCH_NAME\"/" \
    -e "s/ALM_ENABLE_JENKINS=\"N\"/ALM_ENABLE_JENKINS=\"y\"/" \
    -e "s/wget/wget daemon net-tools default-jre-headless/" \
    Dockerfile
echo >> supervisord.conf
echo [program:jenkins] >> supervisord.conf
echo startretries=10 >> supervisord.conf
echo command=service jenkins start >> supervisord.conf
docker build -t ayapapa/docker-alminium .
popd
